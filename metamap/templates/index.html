{% extends "layout.html" %}

{% block page %}

<div class="fail-alert alert alert-danger">
</div>

<table id="mapping-table" class="table table-striped table-condensed table-hover table-bordered">
  <thead>
    <tr>
      <th>IOOS Concept Name</th>
      {%- for src in srcs %}
      <th>
        <a href="#" class="pull-right"><span class="glyphicon glyphicon-resize-horizontal"></span></a>
        {{ src }}
      </th>
      {%- endfor %}
    </tr>
  </thead>

  <tbody>
  {%- for mapping in mappings %}

  <tr data-id="{{mapping._id}}">
    <td>
      <input value="{{ mapping.ioos_name }}" class="" />

      <span class="label label-success saved-indicator pull-left">Saved</span>

      <div class="btn-group pull-right" style="margin-top: 5px;">
        <button class="btn btn-default btn-xs">Evaluate</button>
        <button class="btn btn-danger btn-xs">Delete</button>
      </div>
    </td>

    {%- for x in range(srcs|count) %}
    <td><textarea name="{{ srcs[x] }}">{{ mapping.queries[x] }}</textarea></td>
    {%- endfor %}
  </tr>

  {%- endfor %}

    <tr class="new-row">
      <td>
        <input name="ioos-name" placeholder="New Mapping" class="" />
      </td>

      {%- for src in srcs %}
      <td><textarea name="{{ src }}" placeholder="{{ src }}"></textarea></td>
      {%- endfor %}

    </tr>

  </tbody>
</table>

  <!--
  <div>
    <button class="btn btn-success btn-large" disabled="disabled"><span class="glyphicon glyphicon-plus"></span> Add Mapping</button>
  </div>
  -->

<div id="eval">
  <div class="panel-heading">
    <!--<a href="#" class="pull-right"><span class="glyphicon glyphicon-collapse-down"></span></a>-->
    <a href="#" class="btn btn-xs btn-info pull-right"><span class="glyphicon glyphicon-plus"></span> Add Eval Source</a>
    <h3 class="panel-title">Evaluation</h3>
  </div>
  <div class="panel-body">
    <ul class="list-group">
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="Chen" />
      </li>
      <li class="list-group-item">
        <h4 class="list-group-item-heading">GLOS SST</h4>
        <input type="text" class="list-group-item-text form-control" disabled="disabled" value="NPOSE" />
      </li>
    </ul>
    <!--<a class="btn btn-default btn-large"><span class="glyphicon glyphicon-plus"></span> Add Eval Source</a>-->
  </div>
</div>


<script type="text/javascript">

function evalIoos(row) {
  var row = $(row);
  console.log("eval me " + row.data('id'));
}

function save(row) {
  var row = $(row);

  // build object to send
  var mapping = {
    ioos_name: $('input', row).val(),
    queries: [],
    _id: row.data('id'),
  };

  $('textarea', row).each(function(idx, el) {
    if ($(el).val()) {
      mapping.queries.push({source_type: $(el).attr('name'),
                            query: $(el).val()});
    }
  });

  //console.log(mapping);

  var wat = $.ajax({
    type: 'POST',
    url: '{{ url_for("update_mapping") }}',
    data: {'data':JSON.stringify(mapping, null, '\t')},
  })

  wat.done(function(dat) {
    //console.log(dat);
    if (row.data('id') != dat) {
      row.data('id', dat);
    }

    $('.saved-indicator', row).fadeIn(250).delay(2000).fadeOut(250);
  });

  wat.fail(function(xhr, textStatus, error) {
    row.addClass('error');
    $('.fail-alert').fadeIn(250).text("Could not save: " + textStatus);
  });
}

function rowModified() {
  var parentTr = $(this).parents('tr');
  if (parentTr.data('tid')) {
    window.clearTimeout(parentTr.data('tid'))
  }
  var tid = setTimeout($.proxy(function() {
    // call eval and save
    evalIoos(this);
    save(this);

    // delete timeout id from data
    $(this).data('tid', null);

  }, parentTr), 2500);

  // store this tid in the parent tr's data
  parentTr.data("tid", tid);
}

function newRow() {
  var newTr = $(this).parents('tr');
  
  var cloned = newTr.clone(true).appendTo('#mapping-table tbody');
  // clear out input/textarea - jquery says clone won't copy it, but it does.
  $('input', cloned).val('');
  $('textarea', cloned).val('');

  // remove new-row class and events which trigger a new row creation
  newTr.removeClass('new-row');
  $('input', newTr).off('change');
  $('textarea', newTr).off('change');

  // rig up to autosave
  newTr.on('input', 'input', rowModified);
  newTr.on('input', 'textarea', rowModified);
}

function toggleColumn(colItem) {
  // colItem should be a th or td
  var idx = colItem.parent().children().index(colItem) + 1;

  var col = $('td:nth-child(' + idx + '),th:nth-child(' + idx + ')', colItem.parents('table'));
  col.toggleClass('bigger');

  // toggle all others
  //$('td, th', colItem.parents('table')).not(col).not($('td:first-child, colItem:first-child', colItem.parents('table'))).toggleClass('bigger');
}

$(function() {
  $("#mapping-table tbody tr").not('.new-row').on("input", "input", rowModified);
  $("#mapping-table tbody tr").not('.new-row').on("input", "textarea", rowModified);

  $('#mapping-table .new-row input, #mapping-table .new-row textarea').on("change", newRow);

  $('#mapping-table th a').on('click', function() {
    toggleColumn($(this).parents('th'));
    event.preventDefault();
  });

  $('#mapping-table textarea').on("focus", function() {
    var td = $(this).parents('td');
    if (!td.hasClass('bigger')) {
      toggleColumn(td);

      // one shot close on blur
      $(this).one('blur', function() {
        toggleColumn(td);
      });
    }
  });
});
</script>

{% endblock %}

