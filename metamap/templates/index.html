{% extends "layout.html" %}

{% block page %}

<div class="fail-alert alert alert-danger">
</div>

<table id="mapping-table" class="table table-striped table-condensed table-hover table-bordered">
  <thead>
    <tr>
      <th>IOOS Concept Name</th>
      {%- for src in srcs %}
      <th>
        <a href="#" class="pull-right"><span class="glyphicon glyphicon-resize-horizontal"></span></a>
        {{ src.name }}
      </th>
      {%- endfor %}
    </tr>
  </thead>

  <tbody>
    {%- for mapping in mappings %}

    <tr data-id="{{mapping._id}}">
      <td>
        <input value="{{ mapping.ioos_name }}" class="" />

        <span class="label label-success saved-indicator pull-left">Saved</span>

        <div class="btn-group pull-right" style="margin-top: 5px;">
          <button class="btn btn-default btn-xs eval-btn">Evaluate</button>
          <button class="btn btn-danger btn-xs delete-btn">Delete</button>
        </div>
      </td>

      {%- for x in range(srcs|count) %}
      <td><textarea name="{{ srcs[x]._id }}">{{ mapping.queries[x] }}</textarea></td>
      {%- endfor %}
    </tr>

    {%- endfor %}

    <tr class="new-row">
      <td>
        <input name="ioos-name" placeholder="New Mapping" class="" />
        <span class="label label-success saved-indicator pull-left">Saved</span>

        <div class="btn-group pull-right" style="margin-top: 5px;">
          <button class="btn btn-default btn-xs eval-btn">Evaluate</button>
          <button class="btn btn-danger btn-xs delete-btn">Delete</button>
        </div>
      </td>

      {%- for src in srcs %}
      <td><textarea name="{{ src._id }}" placeholder="{{ src.name }}"></textarea></td>
      {%- endfor %}

    </tr>

  </tbody>
</table>

  <!--
  <div>
    <button class="btn btn-success btn-large" disabled="disabled"><span class="glyphicon glyphicon-plus"></span> Add Mapping</button>
  </div>
  -->

<div id="eval">
  <div class="panel-heading">
    <!--<a href="#" class="pull-right"><span class="glyphicon glyphicon-collapse-down"></span></a>-->
    <button class="btn btn-xs btn-info pull-right" id="add-eval-btn"><span class="glyphicon glyphicon-plus"></span> Add Eval Source</button>
    <h3 class="panel-title">Evaluation: <span></span></h3>
  </div>
  <div class="panel-body">
    <ul class="list-group">
      {%- for eval_source in eval_sources %}
      <li class="list-group-item" data-id="{{ eval_source._id }}">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right edit-eval-btn"><span class="glyphicon glyphicon-info-sign"></span></a>
          <span>{{ eval_source.name }}</span> <small>{{ eval_source.source_type }}</small>
        </h4>
        <div class="input-group">
          <span class="input-group-addon"><span class="glyphicon glyphicon-unchecked"></span></span>
          <input type="text" class="list-group-item-text form-control" disabled="disabled" value="" />
        </div>
      </li>
      {%- endfor %}
    </ul>
    <!--<a class="btn btn-default btn-large"><span class="glyphicon glyphicon-plus"></span> Add Eval Source</a>-->
  </div>
</div>

<div id="eval-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"><span data-mode="add">Add</span><span data-mode="edit">Edit</span> Evaluation Source</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <input type="hidden" name="_id" />
          {%- for f in form %}
          <div class="form-group">
            {% if f.name != "csrf_token" %}
            <label for="{{ f.name }}" class="col-lg-4 control-label">{{ f.label }}</label>
            <div class="col-lg-8">
              {{ f(class_="form-control") }}
            </div>
            {% endif %}
          </div>
          {%- endfor %}
          <span data-mode="edit">
            <div class="form-group">
              <label class="col-lg-4 control-label">Current</label>
              <div class="col-lg-8">
                <p class="form-control-static"></p>
              </div>
            </div>
            <div class="form-group">
              <div class="col-lg-8 col-lg-offset-4">
                <p class="form-control-static">Fill out the URL or File fields to replace this value.</p>
              </div>
            </div>
          </span>
          <span data-mode="add">
            <div class="form-group">
              <div class="col-lg-8 col-lg-offset-4">
                <p class="form-control-static">Fill out the URL or File fields. File takes precedence.</p>
              </div>
            </div>
          </span>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <span data-mode="edit">
          <button type="button" id="del-source" class="btn btn-danger">Delete</button>
          <button type="button" id="edit-source" class="btn btn-primary">Edit Source</button>
        </span>
        <span data-mode="add">
          <button type="button" id="add-source" class="btn btn-primary">Add Source</button>
        </span>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

function evalIoos(row) {
  var row = $(row);
  console.log("eval me " + row.data('id'));

  $('#eval .list-group-item .input-group')
    .removeClass('has-success')
    .removeClass('has-error');

  $('#eval .list-group-item .input-group .glyphicon')
    .removeClass('glyphicon-ok')
    .removeClass('glyphicon-minus-sign')
    .addClass('glyphicon-unchecked');

  $('#eval .list-group-item .input-group input').val('');

  $.getJSON('/eval/' + row.data('id'))
    .done(function(data) {
      console.log(data);

      $('#eval h3.panel-title span').text($('input:first', row).val());

      for (var k in data) {

        // since .data() stores in memory not in html data attributes, can't select on them, have to filter
        var inp = $('input', $('#eval li').filter(function() {
          return $(this).data('id') == k;                                        
        }));

        if (data[k] == null) {
          inp.parent().addClass('has-error');
          inp.val(null);

          $('.glyphicon', inp.parent())
            .removeClass('glyphicon-unchecked')
            .addClass('glyphicon-minus-sign');

        } else {
          inp.val(data[k]);
          inp.parent().addClass('has-success');

          $('.glyphicon', inp.parent())
            .removeClass('glyphicon-unchecked')
            .addClass('glyphicon-ok');
        }
      }
    });
}

function save(row) {
  var row = $(row);

  // build object to send
  var mapping = {
    ioos_name: $('input', row).val(),
    queries: [],
    map_set: "{{ map_set_id }}",
    _id: row.data('id'),
  };

  $('textarea', row).each(function(idx, el) {
    if ($(el).val()) {
      mapping.queries.push({source_type: $(el).attr('name'),
                            query: $(el).val()});
    }
  });

  //console.log(mapping);

  var wat = $.ajax({
    type: 'POST',
    url: '{{ url_for("update_mapping") }}',
    data: {'data':JSON.stringify(mapping, null, '\t')},
  })

  wat.done(function(dat) {
    //console.log(dat);
    if (row.data('id') != dat) {
      row.data('id', dat);
    }

    $('.saved-indicator', row).fadeIn(250).delay(2000).fadeOut(250);
  });

  wat.fail(function(xhr, textStatus, error) {
    row.addClass('error');
    $('.fail-alert').fadeIn(250).text("Could not save: " + textStatus);
  });

  return wat;
}

function rowModified() {
  var parentTr = $(this).parents('tr');
  if (parentTr.data('tid')) {
    window.clearTimeout(parentTr.data('tid'))
  }
  var tid = setTimeout($.proxy(function() {
    // call eval and save
    save(this)
      .done($.proxy(function() {
        evalIoos(this);
      }, this));

    // delete timeout id from data
    $(this).data('tid', null);

  }, parentTr), 2500);

  // store this tid in the parent tr's data
  parentTr.data("tid", tid);
}

function newRow() {
  var newTr = $(this).parents('tr');
  
  var cloned = newTr.clone(true).appendTo('#mapping-table tbody');
  // clear out input/textarea - jquery says clone won't copy it, but it does.
  $('input', cloned).val('');
  $('textarea', cloned).val('');

  // remove new-row class and events which trigger a new row creation
  newTr.removeClass('new-row');
  $('input', newTr).off('change');
  $('textarea', newTr).off('change');

  // rig up to autosave
  newTr.on('input', 'input', rowModified);
  newTr.on('input', 'textarea', rowModified);
}

function toggleColumn(colItem) {
  // colItem should be a th or td
  var idx = colItem.parent().children().index(colItem) + 1;

  var col = $('td:nth-child(' + idx + '),th:nth-child(' + idx + ')', colItem.parents('table'));
  col.toggleClass('bigger');

  // toggle all others
  //$('td, th', colItem.parents('table')).not(col).not($('td:first-child, colItem:first-child', colItem.parents('table'))).toggleClass('bigger');
}

function progressHandler() {
  console.log("i got them handler");
}

// called to handle either add or edit buttons being pressed
function postEvalSource(eid) {
  var formData = new FormData($('#eval-modal form')[0]);
  var url = '{{ url_for("eval_source") }}';
  if (eid != null) {
    url += "/" + eid;
  }
  var req = $.ajax({
    url: url,
    type: 'POST',
    data: formData,
    contentType: false,
    processData: false
  }, 'json');

  return req;
}

$(function() {
  $("#mapping-table tbody tr").not('.new-row').on("input", "input", rowModified);
  $("#mapping-table tbody tr").not('.new-row').on("input", "textarea", rowModified);

  $('#mapping-table .new-row input, #mapping-table .new-row textarea').on("change", newRow);

  $('#mapping-table th a').on('click', function() {
    toggleColumn($(this).parents('th'));
    event.preventDefault();
  });

  var ta = $('#mapping-table textarea').on("focus", function() {
    var td = $(this).parents('td');
    if (!td.hasClass('bigger')) {
      toggleColumn(td);

      // one shot close on blur
      $(this).one('blur', function() {
        toggleColumn(td);
      });
    }
  });
  ta.on('blur', function() {
    $(this).attr('placeholder', '');
  });

  $('#mapping-table .eval-btn').on('click', function() {
    var tr = $(this).parents('tr');
    if (!tr.data('id')) { return; }

    evalIoos(tr);
  });

  $('#mapping-table .delete-btn').on('click', function() {
    var tr = $(this).parents('tr');
    if (!tr.data('id')) { return; }

    var ioosName = $('input', tr).val();

    if (confirm("Are you sure you want to delete the mapping for " + ioosName + "?")) {
      $.post('/delete_mapping', {id:tr.data('id')})
          .done(function() {
            tr.remove();
          })
          .fail(function(xhr, textStatus, error) {
            $('.fail-alert').fadeIn(250).text("Could not delete: " + textStatus);
          });
    }
  });

  $('#add-eval-btn').on('click', function() {
    $('#eval-modal').modal();
    $('#eval-modal span[data-mode="edit"]').hide();
    $('#eval-modal span[data-mode="add"]').show();
    $('#eval-modal input').val('');
    $('#eval-modal select').val(null);
  });

  $('.edit-eval-btn').on('click', function() {
    var eid = $(this).parents('.list-group-item').data('id');
    $.getJSON('/eval_source/' + eid)
      .done(function(data) {
        $('#eval-modal').modal();
        $('#eval-modal span[data-mode="edit"]').show();
        $('#eval-modal span[data-mode="add"]').hide();

        $('#eval-modal input').val('');
        $('#eval-modal select').val(null);

        $('#eval-modal input[name="_id"]').val(data._id);
        $('#eval-modal input[name="name"]').val(data.name);
        $('#eval-modal select[name="source_type"]').val(data.source_type);
        $('#eval-modal .form-control-static:first').text(data.endpoint);
      });
  });

  $('#eval-modal #del-source').on('click', function() {
    var eid = $('#eval-modal input[name="_id"]').val();
    if (confirm("Are you sure you want to delete this source?")) {
      $.post('/delete_source', {id:eid})
        .done(function() {
          $('#eval-modal').modal('hide');
          $('#eval li').filter(function() {
            return $(this).data('id') == eid;
          }).remove();
        })
    }
  });

  $('#eval-modal #edit-source').on('click', function() {
    var eid = $('#eval-modal input[name="_id"]').val();
    var req = postEvalSource(eid);

    req.done(function(data) {
      $('#eval-modal').modal('hide');

      var exist = $('#eval .list-group-item').filter(function() {
        return $(this).data('id') == eid;
      });

      var heading = $('.list-group-item-heading', exist);

      $('>span', heading).text(data.name + ' ');
      $('small', heading).text(data.source_type);

      exist.data('id', data._id);
    });
  });

  $('#eval-modal #add-source').on('click', function() {
    var req = postEvalSource();

    req.progress(function() {
      console.log("progress?");
    });

    req.done(function(data) {
      $('#eval-modal').modal('hide');

      var newList = $('#eval .list-group-item:first').clone(true);
      var heading = $('.list-group-item-heading', newList);

      $('>span', heading).text(data.name + ' ');
      $('small', heading).text(data.source_type);

      newList.data('id', data._id);

      newList.appendTo($('#eval ul'));
    })
    req.fail(function() {
      console.error('failboat');
    })
  });
});
</script>

{% endblock %}

