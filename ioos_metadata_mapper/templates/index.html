{% extends "layout.html" %}

{% block page %}

<div class="">

<div class="col-md-9">
  <table id="mapping-table" class="table table-striped table-condensed table-hover">
    <thead>
      <tr>
        <th>IOOS Concept Name</th>
        {%- for src in srcs %}
        <th>{{ src }}</th>
        {%- endfor %}
      </tr>
    </thead>

    <tbody>
    {%- for mapping in mappings %}

    <tr data-id="{{mapping._id}}">
      <td>
        <input value="{{ mapping.ioos_name }}" class="" />

        <span class="label label-success saved-indicator pull-left">Saved</span>

        <div class="btn-group pull-right" style="margin-top: 5px;">
          <button class="btn btn-default btn-xs">Evaluate</button>
          <button class="btn btn-danger btn-xs">Delete</button>
        </div>
      </td>

      {%- for x in range(srcs|count) %}
      <td><textarea name="{{ srcs[x] }}">{{ mapping.queries[x] }}</textarea></td>
      {%- endfor %}
    </tr>

    {%- endfor %}

      <tr class="new-row">
        <td>
          <input name="ioos-name" placeholder="New Mapping" class="" />
        </td>

        {%- for src in srcs %}
        <td><textarea name="{{ src }}" placeholder="{{ src }}"></textarea></td>
        {%- endfor %}

      </tr>

    </tbody>
  </table>

  <div>
    <button class="btn btn-success btn-large" disabled="disabled"><span class="glyphicon glyphicon-plus"></span> Add Mapping</button>
  </div>
</div>

<div class="col-md-3">
  <div class="panel panel-default panel-info">
    <div class="panel-heading">
      <h3 class="panel-title">Evaluation</h3>
    </div>
    <div class="panel-body">
      <!--
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Endpoint/File</th>
            <th>Evaluated Mapping</th>
          </tr>
        </thead>

        <tbody>
        <tr>
          <td>FVCOM</td>
          <td>NetCDF CF NCML</td>
          <td>http://some.long.com/url/netcfg/</td>
          <td>Chen</td>
        </tr>

      </table>
      -->
      <ul class="list-group">
        <li class="list-group-item">
        <h4 class="list-group-item-heading">
          <a href="#" class="pull-right"><span class="glyphicon glyphicon-info-sign"></span></a>
          FVCOM <small>NetCDF CF NCML</small>
        </h4>
          <textarea class="list-group-item-text" style="width: 100%">Chen</textarea>
        </li>
        <li class="list-group-item">
          <h4 class="list-group-item-heading">GLOS SST</h4>
          <textarea class="list-group-item-text" style="width: 100%">NPOSE</textarea>
        </li>
      </ul>
      <a class="btn btn-default btn-large"><span class="glyphicon glyphicon-plus"></span> Add Eval Source</a>
    </div>
  </div>
</div>

</div>

<script type="text/javascript">

function evalIoos(row) {
  var row = $(row);
  console.log("eval me " + row.data('id'));
}

function save(row) {
  var row = $(row);

  // build object to send
  var mapping = {
    ioos_name: $('input', row).val(),
    queries: [],
    _id: row.data('id'),
  };

  $('textarea', row).each(function(idx, el) {
    if ($(el).val()) {
      mapping.queries.push({source_type: $(el).attr('name'),
                            query: $(el).val()});
    }
  });

  //console.log(mapping);

  var wat = $.ajax({
    type: 'POST',
    url: '{{ url_for("update_mapping") }}',
    data: {'data':JSON.stringify(mapping, null, '\t')},
  })

  wat.done(function(dat) {
    //console.log(dat);
    console.log("done");
    if (row.data('id') != dat) {
      row.data('id', dat);
    }

    $('.saved-indicator', row).fadeIn(250).delay(2000).fadeOut(250);
  });
}

function rowModified() {
  var parentTr = $(this).parents('tr');
  if (parentTr.data('tid')) {
    window.clearTimeout(parentTr.data('tid'))
  }
  var tid = setTimeout($.proxy(function() {
    // call eval and save
    evalIoos(this);
    save(this);

    // delete timeout id from data
    $(this).data('tid', null);

  }, parentTr), 2500);

  // store this tid in the parent tr's data
  parentTr.data("tid", tid);
}

function newRow() {
  var newTr = $(this).parents('tr');
  
  var cloned = newTr.clone(true).appendTo('#mapping-table tbody');
  // clear out input/textarea - jquery says clone won't copy it, but it does.
  $('input', cloned).val('');
  $('textarea', cloned).val('');

  // remove new-row class and events which trigger a new row creation
  newTr.removeClass('new-row');
  $('input', newTr).off('change');
  $('textarea', newTr).off('change');

  // rig up to autosave
  newTr.on('input', 'input', rowModified);
  newTr.on('input', 'textarea', rowModified);
}

$(function() {
  $("#mapping-table tbody tr").not('.new-row').on("input", "input", rowModified);
  $("#mapping-table tbody tr").not('.new-row').on("input", "textarea", rowModified);

  $('#mapping-table .new-row input, #mapping-table .new-row textarea').on("change", newRow);

});
</script>

{% endblock %}

